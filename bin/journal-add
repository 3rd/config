#!/usr/bin/env bun
import { $ } from "bun";

// get user input via yad
const { stdout } = await $`yad --entry --text "Journal entry:" --width 600`.quiet().nothrow();
const text = stdout.toString().trim();

if (text) {
  const dest = `${process.env.HOME}/brain/wiki/journal`;

  // compute date header with ordinal suffix
  const now = new Date();
  const day = now.getDate();
  const suffix = [1, 21, 31].includes(day) ? "st"
    : [2, 22].includes(day) ? "nd"
    : [3, 23].includes(day) ? "rd"
    : "th";
  const month = now.toLocaleString("en-US", { month: "long" });
  const year = now.getFullYear();
  const dateHeader = `* ${year} ${month} ${day}${suffix}`;

  // check if header exists, append if not
  const { exitCode } = await $`grep -qxF ${dateHeader} ${dest}`.nothrow().quiet();
  if (exitCode !== 0) {
    await $`echo ${dateHeader} >> ${dest}`;
  }

  // add entry with timestamp
  const timestamp = now.toISOString().slice(0, 19).replace("T", " ");
  await $`echo "  - ${timestamp}: ${text}" >> ${dest}`;
}
